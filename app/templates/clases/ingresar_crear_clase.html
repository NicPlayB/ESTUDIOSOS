<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Clases Activas</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        .modal-backdrop.show {
            opacity: 0.4 !important;
        }
        .error-text {
            color: #d62828;
            font-size: 0.9rem;
            margin-top: 3px;
        }
    </style>
</head>

<body class="bg-light">

    <a href="{% url 'cerrar_sesion' %}" style="color:red;">
        Cerrar sesión
    </a>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Clases Activas</h2>

        <a href="{% url 'clases_inactivas' %}" class="btn btn-secondary">
            Ver clases inactivas
        </a>
    </div>

    <!-- MENSAJES -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- PROFESOR -->
    {% if rol == 3 %}

    <!-- BOTÓN PARA ABRIR EL FORM FLOTANTE -->
    <button class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#modalCrearClase">
        Crear nueva clase
    </button>

    <!-- MODAL FLOTANTE -->
    <div class="modal fade {% if crear_form.errors %}show{% endif %}"
         id="modalCrearClase"
         style="{% if crear_form.errors %}display:block;{% endif %}"
         tabindex="-1">

        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Crear Clase</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <form method="POST">
                        {% csrf_token %}

                        <!-- Campo: NOMBRE -->
                        <label class="form-label">Nombre de la clase</label>
                        {{ crear_form.nombre }}
                        {% if crear_form.nombre.errors %}
                            <div class="error-text">
                                {{ crear_form.nombre.errors.0 }}
                            </div>
                        {% endif %}

                        <!-- Campo: DESCRIPCIÓN -->
                        <label class="form-label mt-3">Descripción</label>
                        {{ crear_form.descripcion }}
                        {% if crear_form.descripcion.errors %}
                            <div class="error-text">
                                {{ crear_form.descripcion.errors.0 }}
                            </div>
                        {% endif %}

                        <button type="submit" name="crear_clase"
                                class="btn btn-success mt-4 w-100">
                            Crear Clase
                        </button>
                    </form>

                </div>

            </div>
        </div>
    </div>

    <h4>Tus clases activas</h4>

    {% for clase in clases_profesor %}
        <div class="card mb-3">
            <div class="card-body d-flex justify-content-between align-items-center">

                <div>
                    <strong>{{ clase.codigo_clase }}</strong> |
                    {{ clase.nombre }} |
                    Estado: {{ clase.estado }}
                </div>

                <div class="d-flex gap-2">

                    <!-- BOTÓN CORREGIDO -->
                    <a href="{% url 'ver_trabajos' clase.id_clase %}" class="btn btn-info btn-sm">
                        Ver trabajos
                    </a>

                    <form action="{% url 'cambiar_estado_clase' clase.id_clase %}"
                          method="POST" class="d-flex">
                        {% csrf_token %}
                        <select name="estado" class="form-control me-2">
                            <option value="Activa" {% if clase.estado == 'Activa' %}selected{% endif %}>Activa</option>
                            <option value="Inactiva" {% if clase.estado == 'Inactiva' %}selected{% endif %}>Inactiva</option>
                        </select>
                        <button class="btn btn-warning">Actualizar</button>
                        <input type="hidden" name="redirect" value="activas">
                    </form>

                </div>
            </div>
        </div>
    {% endfor %}
    {% endif %}


    <!-- ESTUDIANTE -->
    {% if rol == 4 %}

    <div class="card mb-4">
        <div class="card-header bg-success text-white">Unirse a una clase</div>
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                {{ unirse_form.codigo_clase }}
                <button type="submit" name="unirse_clase" class="btn btn-primary mt-3">Unirse</button>
            </form>
        </div>
    </div>

    <h4>Clases inscritas activas</h4>

    {% for ins in clases_estudiante %}
        {% if ins.clase.estado == "Activa" %}
        <div class="card mb-2">
            <div class="card-body d-flex justify-content-between align-items-center">

                <div>
                    <strong>{{ ins.clase.codigo_clase }}</strong> |
                    {{ ins.clase.nombre }} |
                    Estado: {{ ins.clase.estado }}
                </div>

                <!-- BOTÓN PARA ESTUDIANTE (estaba bien) -->
                <a href="{% url 'ver_trabajos' ins.clase.id_clase %}" class="btn btn-info btn-sm">
                    Ver trabajos
                </a>

            </div>
        </div>
        {% endif %}
    {% endfor %}

    {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% if crear_form.errors %}
<script>
    // Mantener el modal abierto cuando hay errores
    var modal = new bootstrap.Modal(document.getElementById('modalCrearClase'));
    modal.show();
</script>
{% endif %}

</body>
</html>
